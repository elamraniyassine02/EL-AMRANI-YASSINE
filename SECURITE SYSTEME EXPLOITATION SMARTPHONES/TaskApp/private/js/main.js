// private/js/main.js
document.addEventListener("DOMContentLoaded", () => {
    // Get userID from localStorage
    const userID = localStorage.getItem('userID');
    if (!userID) {
        window.location.href = '/login.html';
        return;
    }

    // DOM Elements
    const taskInput = document.getElementById("taskInput");
    const addTaskBtn = document.getElementById("addTaskBtn");
    const taskList = document.getElementById("taskList");
    const userDisplay = document.getElementById("userDisplay");

    // Display username in header
    const displayUsername = () => {
        const username = localStorage.getItem('username');
        if (username && userDisplay) {
            userDisplay.textContent = `Welcome, ${username}!`;
        }
    };

    // Load Tasks from Server
    const loadTasks = async () => {
        try {
            const response = await fetch(`/tasks/${userID}`);
            if (!response.ok) throw new Error('Failed to load tasks');
            
            const tasks = await response.json();
            taskList.innerHTML = ""; // Clear existing tasks
            
            tasks.forEach(task => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.task}</td>
                    <td>${task.username}</td>
                    <td>
                        <button class="delete-btn" data-id="${task.id}">Delete</button>
                    </td>
                `;
                taskList.appendChild(row);

                // Add delete event listener
                row.querySelector(".delete-btn").addEventListener("click", () => 
                    deleteTask(task.id, row)
                );
            });
        } catch (error) {
            console.error("Error loading tasks:", error);
            alert("Failed to load tasks. Please try again.");
        }
    };

    // Add Task
    addTaskBtn.addEventListener("click", async () => {
        const taskText = taskInput.value.trim();
        if (!taskText) {
            alert("Task cannot be empty!");
            return;
        }

        try {
            const response = await fetch('/tasks', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    task: taskText,
                    userID: userID
                })
            });

            if (!response.ok) throw new Error('Failed to add task');
            
            const result = await response.json();
            taskInput.value = ""; // Clear input
            loadTasks(); // Reload all tasks
        } catch (error) {
            console.error("Error adding task:", error);
            alert("Failed to add task. Please try again.");
        }
    });

    // Delete Task
    const deleteTask = async (taskID, row) => {
        try {
            const response = await fetch(`/tasks/${taskID}/${userID}`, {
                method: "DELETE"
            });

            if (!response.ok) throw new Error('Failed to delete task');
            
            row.remove(); // Remove from UI
        } catch (error) {
            console.error("Error deleting task:", error);
            alert("Failed to delete task. Please try again.");
        }
    };

    // Logout functionality
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            try {
                await fetch('/logout', { method: 'POST' });
                localStorage.clear();
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Failed to logout. Please try again.');
            }
        });
    }

    // Initialize
    displayUsername();
    loadTasks();
});